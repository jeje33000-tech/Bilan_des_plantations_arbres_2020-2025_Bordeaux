<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Comparateur Avant / AprÃ¨s</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<!-- Plugins Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-search/dist/leaflet-search.min.css" />

<style>
html, body { height: 100%; margin: 0; }
#map { width: 100%; height: 100%; }
.legend {
    background: white;
    padding: 4px 6px;
    font-size: 11px;
    line-height: 1.2em;
    border-radius: 4px;
}
.stats-panel {
    background: white;
    padding: 6px;
    font-size: 11px;
    border-radius: 4px;
    max-width: 180px;
}
.stats-title {
    font-weight: bold;
    margin-bottom: 4px;
}
.stats-toggle {
    background: white;
    padding: 4px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    text-align: center;
    margin-bottom: 4px;
}
.label-map {
    position: absolute;
    bottom: 10px;
    font-size: 11px;
    padding: 3px 6px;
    background: rgba(255,255,255,0.8);
    border-radius: 4px;
}
.label-left { left: 10px; }
.label-right { right: 10px; }
</style>
</head>
<body>

<div id="map"></div>
<div id="label-left" class="label-map">â¬… AprÃ¨s 2020</div>
<div id="label-right" class="label-map">Avant 2020 âž¡</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.fullscreen/Control.FullScreen.js"></script>
<script src="https://unpkg.com/leaflet-search/dist/leaflet-search.min.js"></script>
<script src="https://unpkg.com/leaflet.sync/L.Map.Sync.min.js"></script>
<script src="https://unpkg.com/leaflet-side-by-side/leaflet-side-by-side.js"></script>

<script>
// --- Cartes ---
var mapBefore = L.map('map', {
    fullscreenControl: true,
    zoomControl: false
}).setView([44.84, -0.58], 13);

var mapAfter = L.map(document.createElement('div')).setView([44.84, -0.58], 13);

var osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
});
osm.addTo(mapBefore);
osm.addTo(mapAfter);

// --- DonnÃ©es exemple ---
var beforeLayer = L.geoJSON(beforeGeoJSON, {
    style: { color: "orange", weight: 1, fillOpacity: 0.3 }
});
var afterLayer = L.geoJSON(afterGeoJSON, {
    style: { color: "green", weight: 1, fillOpacity: 0.3 },
    onEachFeature: function (feature, layer) {
        layer.bindPopup("CODE_STATION: " + feature.properties.CODE_STATION);
    }
});
beforeLayer.addTo(mapBefore);
afterLayer.addTo(mapAfter);

// --- Surbrillance ---
var highlight;
function highlightFeature(e) {
    if (highlight) {
        afterLayer.resetStyle(highlight);
    }
    var layer = e.target;
    layer.setStyle({
        weight: 2,
        color: '#ff0000',
        fillOpacity: 0.3
    });
    highlight = layer;
}
afterLayer.eachLayer(function (layer) {
    layer.on('click', highlightFeature);
});

// --- Sync ---
mapBefore.sync(mapAfter);
mapAfter.sync(mapBefore);

// --- Swipe ---
L.control.sideBySide(beforeLayer, afterLayer).addTo(mapBefore);

// --- LÃ©gende ---
var legend = L.control({ position: 'topleft' });
legend.onAdd = function () {
    var div = L.DomUtil.create('div', 'legend');
    div.innerHTML = "<strong>Nombre total de stations</strong><br>" + afterLayer.getLayers().length;
    return div;
};
legend.addTo(mapBefore);

// --- Stats dynamiques ---
var statsPanel = L.control({ position: 'topleft' });
statsPanel.onAdd = function () {
    var container = L.DomUtil.create('div');
    var toggle = L.DomUtil.create('div', 'stats-toggle', container);
    toggle.innerHTML = "ðŸ“Š Stats";
    var panel = L.DomUtil.create('div', 'stats-panel', container);
    panel.innerHTML = "<div class='stats-title'>Nombre de stations aprÃ¨s 2020 visibles</div><div id='stats-count'></div>";
    toggle.onclick = function () {
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    };
    return container;
};
statsPanel.addTo(mapBefore);

// Fonction de mise Ã  jour stats
function updateStats() {
    var count = 0;
    afterLayer.eachLayer(function (layer) {
        if (mapAfter.getBounds().intersects(layer.getBounds())) {
            count++;
        }
    });
    document.getElementById('stats-count').innerHTML = count;
}
mapAfter.on('moveend', updateStats);
updateStats();

// --- Recherche ---
var searchControl = new L.Control.Search({
    layer: afterLayer,
    propertyName: 'CODE_STATION',
    marker: false,
    moveToLocation: function (latlng, title, map) {
        map.setView(latlng, 18);
    }
});
searchControl.on('search:locationfound', function (e) {
    if (highlight) {
        afterLayer.resetStyle(highlight);
    }
    e.layer.setStyle({
        weight: 2,
        color: '#ff0000',
        fillOpacity: 0.3
    });
    highlight = e.layer;
    e.layer.openPopup();
});
mapBefore.addControl(searchControl);

// --- Boutons zoom & nord ---
L.control.zoom({ position: 'topright' }).addTo(mapBefore);
L.control.compass = function (opts) {
    var control = L.control({ position: opts.position });
    control.onAdd = function () {
        var div = L.DomUtil.create('div', 'leaflet-bar');
        div.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/b/b2/Compass_icon.svg/48px-Compass_icon.svg.png" style="width:26px;height:26px;">';
        return div;
    };
    return control;
};
L.control.compass({ position: 'topright' }).addTo(mapBefore);

</script>
</body>
</html>
