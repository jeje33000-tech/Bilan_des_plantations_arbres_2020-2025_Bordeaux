<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Test Synchro & Stats Mapbox</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body, html { margin:0; padding:0; height:100%; }
  #before, #after { position:absolute; top:0; bottom:0; width:50%; }
  #after { left:50%; }
  #stats { position: absolute; bottom: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; font-family: Arial; font-size: 13px; z-index: 10; max-width: 300px; }
</style>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
</head>
<body>

<div id="before"></div>
<div id="after"></div>
<div id="stats">Chargement...</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiamVqZTMzMDAwIiwiYSI6ImNtZTJ2c3RnaDAwczEyanF6bW9wODI0cTgifQ.AYOAKWDyDLP_fbKIz-QdwQ';

const center = [-0.57409, 44.861022];
const zoomInit = 11.5;

const beforeMap = new mapboxgl.Map({
  container: 'before',
  style: 'mapbox://styles/mapbox/streets-v11',
  center,
  zoom: zoomInit
});
const afterMap = new mapboxgl.Map({
  container: 'after',
  style: 'mapbox://styles/mapbox/outdoors-v12',
  center,
  zoom: zoomInit
});

// Flag pour éviter boucle infinie
let syncing = false;

// Synchroniser la carte "après" quand "avant" bouge
beforeMap.on('move', () => {
  if (syncing) return;
  syncing = true;
  const center = beforeMap.getCenter();
  const zoom = beforeMap.getZoom();
  const bearing = beforeMap.getBearing();
  const pitch = beforeMap.getPitch();
  afterMap.jumpTo({center, zoom, bearing, pitch});
  syncing = false;
});

// Synchroniser la carte "avant" quand "après" bouge
afterMap.on('move', () => {
  if (syncing) return;
  syncing = true;
  const center = afterMap.getCenter();
  const zoom = afterMap.getZoom();
  const bearing = afterMap.getBearing();
  const pitch = afterMap.getPitch();
  beforeMap.jumpTo({center, zoom, bearing, pitch});
  syncing = false;
});

// Données test : simulate station GeoJSON avec points simples
const stationsAvant = {
  "type": "FeatureCollection",
  "features": [
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-0.58, 44.86] }, "properties": { "CODE_STATION": "AV01" } },
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-0.56, 44.86] }, "properties": { "CODE_STATION": "AV02" } }
  ]
};
const stationsApres = {
  "type": "FeatureCollection",
  "features": [
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-0.57, 44.862] }, "properties": { "CODE_STATION": "AP01" } },
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-0.55, 44.865] }, "properties": { "CODE_STATION": "AP02" } },
    { "type": "Feature", "geometry": { "type": "Point", "coordinates": [-0.60, 44.860] }, "properties": { "CODE_STATION": "AP03" } }
  ]
};

beforeMap.on('load', () => {
  beforeMap.addSource('stationsAvant', { type: 'geojson', data: stationsAvant });
  beforeMap.addLayer({
    id: 'stationsAvantLayer',
    type: 'circle',
    source: 'stationsAvant',
    paint: { 'circle-radius': 8, 'circle-color': 'green', 'circle-opacity': 0.6 }
  });
});

afterMap.on('load', () => {
  afterMap.addSource('stationsApres', { type: 'geojson', data: stationsApres });
  afterMap.addLayer({
    id: 'stationsApresLayer',
    type: 'circle',
    source: 'stationsApres',
    paint: { 'circle-radius': 8, 'circle-color': 'red', 'circle-opacity': 0.6 }
  });
});

// Fonction pour compter stations visibles dans bounds
function countVisibleStations(map, sourceId) {
  const bounds = map.getBounds();
  const features = map.querySourceFeatures(sourceId);
  let count = 0;
  for (const f of features) {
    const coords = f.geometry.coordinates;
    if (bounds.contains(coords)) count++;
  }
  return count;
}

// Mise à jour stats à chaque fin de déplacement de la carte "après"
afterMap.on('moveend', () => {
  const countAvant = countVisibleStations(afterMap, 'stationsAvant'); // attention, pas de source sur afterMap pour stationsAvant
  const countApres = countVisibleStations(afterMap, 'stationsApres');
  // Ici, stationsAvant n'existe pas sur afterMap, donc on va compter dans beforeMap pour stationsAvant
  const countAvantOnBefore = countVisibleStations(beforeMap, 'stationsAvant');
  const countApresOnAfter = countVisibleStations(afterMap, 'stationsApres');

  const statsDiv = document.getElementById('stats');
  statsDiv.innerHTML = `
    <strong>Stations visibles :</strong><br/>
    Avant 2020 : ${countAvantOnBefore}<br/>
    Après 2020 : ${countApresOnAfter}
  `;
});

// Aussi appel initial pour stats
afterMap.on('load', () => {
  afterMap.fire('moveend');
});
beforeMap.on('load', () => {
  beforeMap.fire('moveend');
});

</script>

</body>
</html>
