<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Swipe Avant/Après avec surbrillance locale</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.css" rel="stylesheet" />
<style>
  body, html { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
  #container { position:relative; width:100%; height:100vh; }
  #before, #after { position:absolute; top:0; bottom:0; width:100%; }
  #legend {
    position: absolute;
    top: 10px;
    left: 10px;
    max-width: 280px;
    background: rgba(255,255,255,0.9);
    padding: 6px 12px;
    border-radius: 5px;
    font-size: 12px;
    z-index: 1000;
    pointer-events: none;
  }
  #legend h4 {
    margin: 6px 0 4px;
    font-weight: bold;
    font-size: 13px;
  }
  #label-left, #label-right {
    position: absolute;
    bottom: 30px;
    padding: 5px 12px;
    font-size: 14px;
    font-weight: bold;
    background: rgba(255,255,255,0.85);
    border-radius: 3px;
    pointer-events: none;
    white-space: nowrap;
    z-index: 1000;
    transition: opacity 0.3s ease;
  }
  #label-right::after {
    content: " ➔";
  }
  #label-left { left: 10px; }
  #label-right { right: 10px; }
  #stats {
    position: absolute;
    bottom: 10px;
    right: 10px;
    width: 280px;
    height: 180px;
    background: rgba(255,255,255,0.9);
    border-radius: 5px;
    padding: 10px;
    font-size: 12px;
    z-index: 1000;
    box-sizing: border-box;
  }
  #toggle-stats-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1100;
    background: #0074D9;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    font-size: 13px;
  }
</style>
</head>
<body>

<div id="container">
  <div id="after"></div> <!-- after à gauche -->
  <div id="before"></div> <!-- before à droite -->
</div>

<div id="label-left">Après 2020</div>
<div id="label-right">Avant 2020</div>

<div id="legend">
  <h4>Légende</h4>
  <div><span style="background:#FF4500;width:18px;height:14px;display:inline-block;margin-right:6px;border:1px solid #555;"></span> Stations créées ou en cours</div>
  <div><span style="background:orange;width:18px;height:14px;display:inline-block;margin-right:6px;border:1px solid #555;"></span> Stations remplacées/densifiées</div>
  <div><span style="background:green;width:18px;height:14px;display:inline-block;margin-right:6px;border:1px solid #555;"></span> Stations non plantées</div>
  <div style="margin-top:8px;"><span style="background:green;width:18px;height:14px;display:inline-block;margin-right:6px;border:1px solid #555;"></span> Stations avant 2020</div>
</div>

<button id="toggle-stats-btn">Afficher stats</button>

<div id="stats" style="display:none;">
  <canvas id="chart"></canvas>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.4.0/mapbox-gl-compare.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiamVqZTMzMDAwIiwiYSI6ImNtZTJ2c3RnaDAwczEyanF6bW9wODI0cTgifQ.AYOAKWDyDLP_fbKIz-QdwQ';

const centerBordeaux = [-0.57409, 44.861022];

const afterMap = new mapboxgl.Map({
  container: 'after',
  style: 'mapbox://styles/mapbox/dark-v11',
  center: centerBordeaux,
  zoom: 11.5,
  attributionControl: false
});
const beforeMap = new mapboxgl.Map({
  container: 'before',
  style: 'mapbox://styles/mapbox/dark-v11',
  center: centerBordeaux,
  zoom: 11.5,
  attributionControl: false
});

// Ajouter controls communs
[afterMap, beforeMap].forEach(m => {
  m.addControl(new mapboxgl.NavigationControl());
  m.addControl(new mapboxgl.GeolocateControl({trackUserLocation: true}));
  m.addControl(new mapboxgl.FullscreenControl());
  m.addControl(new mapboxgl.ScaleControl({unit: 'metric'}));
});

// Barre de recherche simple (par CODE_STATION)
function addSearchControl(map) {
  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Rechercher CODE_STATION';
  input.style.position = 'absolute';
  input.style.top = '10px';
  input.style.left = '50%';
  input.style.transform = 'translateX(-50%)';
  input.style.zIndex = 1500;
  input.style.padding = '4px 8px';
  input.style.fontSize = '12px';
  input.style.borderRadius = '3px';
  input.style.border = '1px solid #aaa';
  input.style.background = 'white';
  map.getContainer().appendChild(input);

  input.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      const val = input.value.trim().toUpperCase();
      if (!val) return;
      // Recherche dans toutes couches de cette map
      let found = false;
      [beforeMap, afterMap].forEach(mp => {
        mp.getStyle().sources && Object.keys(mp.getStyle().sources).forEach(sourceId => {
          const source = mp.getSource(sourceId);
          if (!source || !source._data) return;
          const feat = source._data.features.find(f => f.properties.CODE_STATION && f.properties.CODE_STATION.toUpperCase() === val);
          if (feat) {
            mp.flyTo({center: feat.geometry.coordinates, zoom: 16});
            found = true;
          }
        });
      });
      if (!found) alert('CODE_STATION introuvable');
    }
  });
}

addSearchControl(afterMap);
addSearchControl(beforeMap);

// Inverser les cartes dans Compare
const compare = new mapboxgl.Compare(afterMap, beforeMap, '#container', {});

const layersAvant = [
  { map: beforeMap, id: 'avant-layer', source: 'avant', color: 'green', label: 'Stations avant 2020', data: null, totalCount: 0, visibleCount: 0 }
];

const layersApres = [
  { map: afterMap, id: 'apres1-layer', source: 'apres1', color: '#FF4500', label: 'Stations créées ou en cours', data: null, totalCount: 0, visibleCount: 0 },
  { map: afterMap, id: 'apres2-layer', source: 'apres2', color: 'orange', label: 'Stations remplacées/densifiées', data: null, totalCount: 0, visibleCount: 0 },
  { map: afterMap, id: 'apres3-layer', source: 'apres3', color: 'green', label: 'Stations non plantées', data: null, totalCount: 0, visibleCount: 0 }
];

let popup = null;

async function addLayer(info) {
  try {
    const response = await fetch(info.source + '.geojson');
    if (!response.ok) throw new Error('Erreur chargement ' + info.source + '.geojson');
    const geojson = await response.json();
    info.data = geojson;
    info.totalCount = geojson.features.length;

    info.map.addSource(info.source, {
      type: 'geojson',
      data: geojson
    });

    info.map.addLayer({
      id: info.id,
      type: 'fill',
      source: info.source,
      paint: {
        'fill-color': info.color,
        'fill-opacity': 0.6
      }
    });

    if (info.map === afterMap) {
      info.map.addLayer({
        id: info.id + '-highlight',
        type: 'fill',
        source: info.source,
        paint: {
          'fill-color': '#ffff00',
          'fill-opacity': 0.3
        },
        filter: ['==', 'fid', ''] // filtre vide initial
      });
    }

    info.map.addLayer({
      id: info.id + '-label',
      type: 'symbol',
      source: info.source,
      layout: {
        'text-field': ['get', 'CODE_STATION'],
        'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
        'text-size': 11,
        'text-anchor': 'center',
        'visibility': 'none'
      },
      paint: {
        'text-color': info.color,
        'text-halo-color': '#000',
        'text-halo-width': 1
      }
    });

    info.map.on('zoom', () => {
      const zoom = info.map.getZoom();
      const visibility = zoom >= 15 ? 'visible' : 'none';
      if (info.map.getLayoutProperty(info.id + '-label', 'visibility') !== visibility) {
        info.map.setLayoutProperty(info.id + '-label', 'visibility', visibility);
      }
    });

    if (info.map === afterMap) {
      info.map.on('click', info.id, (e) => {
        if (!e.features.length) return;
        const feature = e.features[0];
        const coordinates = e.lngLat;
        const codeStation = feature.properties.CODE_STATION || 'N/A';

        if (popup) popup.remove();

        popup = new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(`<strong>Code station:</strong> ${codeStation}`)
          .addTo(info.map);

        // Mettre à jour filtre sur la couche highlight
        info.map.setFilter(info.id + '-highlight', ['==', 'fid', feature.properties.fid]);
      });

      info.map.on('mouseenter', info.id, () => {
        info.map.getCanvas().style.cursor = 'pointer';
      });
      info.map.on('mouseleave', info.id, () => {
        info.map.getCanvas().style.cursor = '';
      });
    }

  } catch (err) {
    console.error('Erreur chargement couche ' + info.source, err);
  }
}

async function loadAllLayers() {
  for (const layer of [...layersAvant, ...layersApres]) {
    await addLayer(layer);
  }
}

loadAllLayers().then(() => {
  updateStats();
});

function updateLabels(sliderPos) {
  document.getElementById('label-left').style.opacity = sliderPos;
  document.getElementById('label-right').style.opacity = 1 - sliderPos;
}

compare.on('slide', e => {
  updateLabels(e.detail);
  updateStats();
});
updateLabels(0);

function countVisibleStations(layerInfo) {
  if (!layerInfo.data) return 0;
  const bounds = layerInfo.map.getBounds();

  return layerInfo.data.features.filter(f => {
    let coord = null;
    if (f.geometry.type === 'Point') {
      coord = f.geometry.coordinates;
    } else if (f.geometry.type === 'Polygon') {
      coord = f.geometry.coordinates[0][0];
    } else if (f.geometry.type === 'MultiPolygon') {
      coord = f.geometry.coordinates[0][0][0];
    }
    return coord ? bounds.contains(coord) : false;
  }).length;
}

const ctx = document.getElementById('chart').getContext('2d');

const chart = new Chart(ctx, {
  type: 'bar',
  data: {
    labels: [],
    datasets: [{
      label: 'Nombre stations visibles',
      data: [],
      backgroundColor: []
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y: { beginAtZero: true }
    },
    plugins: {
      legend: { display: false }
    }
  }
});

function updateStats() {
  layersApres.forEach(l => {
    l.visibleCount = countVisibleStations(l);
  });

  const allLayers = layersApres;

  chart.data.labels = allLayers.map(l => l.label);
  chart.data.datasets[0].data = allLayers.map(l => l.visibleCount);
  chart.data.datasets[0].backgroundColor = allLayers.map(l => l.color);
  chart.update();
}

afterMap.on('move', updateStats);
beforeMap.on('move', updateStats);

// Bouton toggle stats
const toggleStatsBtn = document.getElementById('toggle-stats-btn');
const statsDiv = document.getElementById('stats');
toggleStatsBtn.onclick = () => {
  if (statsDiv.style.display === 'none') {
    statsDiv.style.display = 'block';
    toggleStatsBtn.textContent = 'Masquer stats';
  } else {
    statsDiv.style.display = 'none';
    toggleStatsBtn.textContent = 'Afficher stats';
  }
};
</script>

</body>
</html>
